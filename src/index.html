<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Text Editor</title>
  <link rel="stylesheet" href="../node_modules/codemirror/lib/codemirror.css">
  <link rel="stylesheet" href="../node_modules/codemirror/theme/material-darker.css">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background-color: #1e1e1e;
      color: #d4d4d4;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    #toolbar {
      display: flex;
      gap: 8px;
      padding: 8px;
      background-color: #2d2d2d;
      border-bottom: 1px solid #404040;
    }

    #toolbar button {
      padding: 6px 12px;
      background-color: #3c3c3c;
      color: #d4d4d4;
      border: 1px solid #505050;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
    }

    #toolbar button:hover {
      background-color: #4c4c4c;
    }

    #editor-container {
      flex: 1;
      overflow: hidden;
    }

    .CodeMirror {
      height: 100%;
      font-family: 'Cascadia Code', 'Fira Code', Consolas, 'Courier New', monospace;
      font-size: 14px;
    }

    #statusbar {
      display: flex;
      justify-content: space-between;
      padding: 4px 12px;
      background-color: #007acc;
      color: white;
      font-size: 12px;
    }

    #statusbar .left {
      display: flex;
      gap: 20px;
    }

    #statusbar .right {
      display: flex;
      gap: 20px;
    }
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="btn-new">New</button>
    <button id="btn-open">Open</button>
    <button id="btn-save">Save</button>
    <button id="btn-save-as">Save As</button>
  </div>

  <div id="editor-container">
    <textarea id="editor"></textarea>
  </div>

  <div id="statusbar">
    <div class="left">
      <span id="status-text">Ready</span>
    </div>
    <div class="right">
      <span id="status-position">Ln 1, Col 1</span>
      <span id="status-encoding">UTF-8</span>
      <span id="status-language">Plain Text</span>
    </div>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const path = require('path');
    const CodeMirror = require('codemirror');

    // Load language modes
    require('codemirror/mode/javascript/javascript');
    require('codemirror/mode/xml/xml');
    require('codemirror/mode/htmlmixed/htmlmixed');
    require('codemirror/mode/css/css');
    require('codemirror/mode/clike/clike');
    require('codemirror/mode/python/python');
    require('codemirror/mode/sql/sql');
    require('codemirror/mode/markdown/markdown');
    require('codemirror/mode/yaml/yaml');

    // State
    let currentFilePath = null;
    let currentEncoding = 'utf-8';
    let isDirty = false;

    // Initialize CodeMirror
    const editor = CodeMirror.fromTextArea(document.getElementById('editor'), {
      lineNumbers: true,
      theme: 'material-darker',
      mode: 'text/plain',
      indentUnit: 4,
      tabSize: 4,
      indentWithTabs: true,
      lineWrapping: false,
      autoCloseBrackets: true,
      matchBrackets: true
    });

    // Track changes
    editor.on('change', () => {
      if (!isDirty) {
        isDirty = true;
        updateTitle();
      }
    });

    // Track cursor position
    editor.on('cursorActivity', () => {
      const pos = editor.getCursor();
      updatePosition(pos.line + 1, pos.ch + 1);
    });

    // Button event listeners
    document.getElementById('btn-new').addEventListener('click', newFile);
    document.getElementById('btn-open').addEventListener('click', openFile);
    document.getElementById('btn-save').addEventListener('click', saveFile);
    document.getElementById('btn-save-as').addEventListener('click', saveFileAs);

    // IPC listeners
    ipcRenderer.on('menu-new', () => newFile());
    ipcRenderer.on('menu-save', () => saveFile());
    ipcRenderer.on('menu-save-as', () => saveFileAs());
    ipcRenderer.on('file-opened', (_, data) => loadFile(data));

    function newFile() {
      currentFilePath = null;
      currentEncoding = 'utf-8';
      isDirty = false;
      editor.setValue('');
      editor.setOption('mode', 'text/plain');
      updateTitle();
      updateStatus('New file created');
      updateEncoding('UTF-8');
      updateLanguage('Plain Text');
    }

    async function openFile() {
      await ipcRenderer.invoke('open-file-dialog');
    }

    function loadFile(data) {
      console.log('Loading file:', data.filePath);
      currentFilePath = data.filePath;
      currentEncoding = data.encoding;
      isDirty = false;

      editor.setValue(data.content);

      // Set the language mode based on file type
      const mode = getCodeMirrorMode(data.language);
      editor.setOption('mode', mode);

      updateTitle();
      updateStatus('Opened: ' + path.basename(data.filePath));
      updateEncoding(data.encoding.toUpperCase());
      updateLanguage(getLanguageDisplayName(data.language));
    }

    async function saveFile() {
      if (!currentFilePath) {
        await saveFileAs();
        return;
      }

      const content = editor.getValue();
      const result = await ipcRenderer.invoke('save-file', {
        filePath: currentFilePath,
        content,
        encoding: currentEncoding
      });

      if (result.success) {
        isDirty = false;
        updateTitle();
        updateStatus('File saved');
      } else {
        updateStatus('Error: ' + result.error);
      }
    }

    async function saveFileAs() {
      const content = editor.getValue();
      const suggestedName = currentFilePath ? path.basename(currentFilePath) : 'untitled.txt';

      const result = await ipcRenderer.invoke('save-file-dialog', {
        content,
        encoding: currentEncoding,
        suggestedName
      });

      if (result.success) {
        currentFilePath = result.filePath;
        isDirty = false;
        updateTitle();
        updateStatus('File saved');
      } else if (!result.canceled) {
        updateStatus('Error: ' + result.error);
      }
    }

    function updateTitle() {
      const fileName = currentFilePath ? path.basename(currentFilePath) : 'Untitled';
      document.title = (isDirty ? '* ' : '') + fileName + ' - Text Editor';
    }

    function updateStatus(text) {
      document.getElementById('status-text').textContent = text;
    }

    function updatePosition(line, col) {
      document.getElementById('status-position').textContent = 'Ln ' + line + ', Col ' + col;
    }

    function updateEncoding(encoding) {
      document.getElementById('status-encoding').textContent = encoding;
    }

    function updateLanguage(language) {
      document.getElementById('status-language').textContent = language;
    }

    function getCodeMirrorMode(language) {
      const modes = {
        'html': 'htmlmixed',
        'xml': 'xml',
        'json': { name: 'javascript', json: true },
        'javascript': 'javascript',
        'typescript': { name: 'javascript', typescript: true },
        'css': 'css',
        'scss': 'text/x-scss',
        'less': 'text/x-less',
        'csharp': 'text/x-csharp',
        'c': 'text/x-csrc',
        'cpp': 'text/x-c++src',
        'java': 'text/x-java',
        'python': 'python',
        'sql': 'sql',
        'markdown': 'markdown',
        'yaml': 'yaml',
        'plaintext': 'text/plain'
      };
      return modes[language] || 'text/plain';
    }

    function getLanguageDisplayName(lang) {
      const names = {
        'plaintext': 'Plain Text',
        'html': 'HTML',
        'xml': 'XML',
        'json': 'JSON',
        'javascript': 'JavaScript',
        'typescript': 'TypeScript',
        'csharp': 'C#',
        'css': 'CSS',
        'scss': 'SCSS',
        'less': 'Less',
        'java': 'Java',
        'sql': 'SQL',
        'c': 'C',
        'cpp': 'C++',
        'python': 'Python',
        'markdown': 'Markdown',
        'yaml': 'YAML'
      };
      return names[lang] || lang;
    }

    // Initialize
    updateTitle();
    editor.focus();
  </script>
</body>
</html>
